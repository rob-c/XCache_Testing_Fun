
# Setting up an XCache server

## Transparent XCache server

### Setting up XCache services on Server

Firstly you will need to setup the normal VOMS and CA packages on this server as well as having fetch-crl setup to regularly update the crl lists for certificates.
Instructions on this can be found elsewhere on the gridpp wiki pages.

You will also need this host to have a certified and valid grid certificate.


You will also need to install the XRootD and tcmalloc packages from epel.

```
xrootd-voms.x86_64
xrootd-client-libs.x86_64
gperftools-libs.x86_64
```


Configuring the XRootD package.

The following is the config from the XCache at ECDF.

```
ofs.osslib    libXrdPss.so
pss.cachelib  libXrdFileCache.so
pfc.ram       1g
pfc.diskusage 0.55 0.75
oss.localroot /gridstorage/cache/

all.export /xroot:/
all.export /root:/
pss.origin =
pss.setopt DebugLevel 3
pss.setopt ParStreamsPerPhyConn 4

# Allow all WN
xrd.allow host *.ecdf.ed.ac.uk

#xrootd.seclib libXrdSec.so
sec.protocol /usr/lib64 gsi -crl:3 -key:/etc/grid-security/xrootd/hostkey.pem -cert:/etc/grid-security/xrootd/hostcert.pem -md:sha256:sha1 -ca:2 -gmapopt:10 -vomsfun:/usr/lib64/libXrdSecgsiVOMS-4.so

# Use SSS for authentication
sec.protocol sss -s /etc/grid-security/xrd/sss.keytab.grp -c /etc/grid-security/xrd/sss.keytab.grp
# Use SSS for storage which are only servers under glite.ecdf.ed.ac.uk
sec.protbind *glite.ecdf.ed.ac.uk only sss
```

Important lines here are:

 * `oss.localroot` This is the location of the local POSIX filesystem which will be used for caching data.
 * `pfc.diskusage` This is how much of the mount-space to use for cached-data.
 * `xrd.allow host` This is the addresses of the hosts which are allowed to access the cache.
 * `sec.protocol` This is the same as with DPM, i.e. use grid-authentication for incoming connections.
 * `sec.*` These other lines 

### Authentication 

Incoming connections from WN are authenticated using X509.

Outbound connections to the SE is handled using a secure truested token.

At ECDF `/etc/grid-security/xrd/sss.keytab.grp` was generated by `xrdsssadmin -u nobody -g atlas add /etc/grid-security/xrd/sss.keytab.grp`.

To make sure the XCache is trusted by the site storage. The following was added to each disk node in the xrootd service config.
In particular in section starting: `if exec xrootd`.

```
sec.protocol sss -s /etc/grid-security/xrd/sss.keytab.grp -c /etc/grid-security/xrd/sss.keytab.grp
sec.protbind gridpp09.ecdf.ed.ac.uk only sss
```

This can be done with any appropriate xrootd secure token provided that it's been authorized by the SE for use.


### Firewall

Add an appropriate firewall rule into your iptables and ip6tables to allow external servers to access your XCache.

```
-A INPUT -p tcp -m tcp --dport 1094 -j ACCEPT -m comment --comment "allow xrootd"
```


### Running the service

The XRootD service has to be launched using this config file:

`LD_PRELOAD=/usr/lib64/libtcmalloc.so xrootd  -p 1094 -k 100 -I v4 -b -l /var/log/xrootd.log -c /etc/config/xcache.cfg`

Some useful environment configs to improve the performance of this.

```
#!/bin/bash
# rcurrie increasing debug for debugging issues
export XrdSecDEBUG=3
# rcurrie following: https://github.com/wyang007/rucioN2N-for-Xcache/wiki/Introduction-to-Xrootd-N2N-for-Disk-Caching-Proxy-(Xcache)-utilizing-RUCIO-metalink
export TCMALLOC_RELEASE_RATE=10
# Enable Local file metalink processing
export XRD_METALINKPROCESSING=1
# Enable Local file metalink processing
export XRD_LOCALMETALINKFILE=1
# Turn off wait on error before retry
export XRD_STREAMERRORWINDOW=5
# Increase number of retries before giving up
export XRD_CONNECTIONRETRY=50
# Increase timeout on streaming
export XRD_STREAMTIMEOUT=120
# Enable TCPKEEPALIVE
export XRD_TCPKEEPALIVE=1
# Bump up number of workers
export XRD_WORKERTHREADS=12
# Keep to V4 mode
export XRD_NETWORKSTACK=IPv4
# Incease loglevel
export XRD_LOGLEVEL=Debug
```


## Opaque XCache server


### Setting up XCache services on Server


### Authenticaion


### Firewall



